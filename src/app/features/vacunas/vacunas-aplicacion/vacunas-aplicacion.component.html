<div class="flex flex-1 overflow-hidden">
    <div class="flex-1 overflow-y-auto w-full bg-slate-50/30">
        <div class="max-w-7xl mx-auto flex flex-col gap-6">


            <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                <!-- Left Column: History -->
                <div class="xl:col-span-2 flex flex-col gap-4">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                            <svg class="w-5 h-5 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            Historial de Vacunación
                        </h3>
                        <button
                            class="text-sm text-teal-600 font-bold hover:text-teal-700 flex items-center gap-1.5 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Exportar Registros
                        </button>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead
                                    class="bg-slate-50 border-b border-slate-200 text-slate-500 uppercase tracking-wider text-xs font-bold">
                                    <tr>
                                        <th class="px-6 py-4">Vacuna</th>
                                        <th class="px-6 py-4">Fecha</th>
                                        <th class="px-6 py-4">Dosis</th>
                                        <th class="px-6 py-4">Aplicada Por</th>
                                        <th class="px-6 py-4">Estado</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    <tr *ngFor="let vacuna of historialVacunas()"
                                        class="hover:bg-slate-50 transition-colors">
                                        <td class="px-6 py-4 font-semibold text-slate-800">{{vacuna.vacunaNombre}}</td>
                                        <td class="px-6 py-4 text-slate-600">{{vacuna.fechaAplicacion |
                                            date:'dd/MM/yyyy'}}</td>
                                        <td class="px-6 py-4 text-slate-600">{{vacuna.dosis}}</td>
                                        <td class="px-6 py-4 text-slate-600">{{vacuna.aplicadaPor ||
                                            vacuna.aplicadaPorNombre || 'Desconocido'}}</td>
                                        <td class="px-6 py-4">
                                            <span
                                                class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-bold bg-teal-50 text-teal-700 border border-teal-100">
                                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor"
                                                    viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2" d="M5 13l4 4L19 7" />
                                                </svg>
                                                Aplicada
                                            </span>
                                        </td>
                                    </tr>
                                    <tr *ngIf="historialVacunas().length === 0">
                                        <td colspan="5" class="px-6 py-8 text-center text-slate-500 italic">
                                            No hay vacunas registradas para este paciente.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="px-6 py-4 border-t border-slate-200 bg-slate-50 flex justify-center">
                            <!-- Optional footer content -->
                        </div>
                    </div>

                    <!-- Próxima Vacuna Card -->
                    <div *ngIf="paciente()"
                        class="bg-gradient-to-br from-teal-50 to-cyan-50 rounded-xl shadow-sm border border-teal-200 p-5">
                        <div class="flex items-start gap-3">
                            <div
                                class="flex-shrink-0 w-10 h-10 bg-teal-600 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-sm font-bold text-teal-900 mb-1">Información del Paciente</h4>
                                <p class="text-xs text-teal-700">
                                    <span class="font-semibold">{{ paciente()?.nombre }} {{ paciente()?.apellido
                                        }}</span>
                                    <br>
                                    Edad: <span class="font-semibold">{{ edadPacienteMeses() }} meses</span>
                                </p>
                            </div>
                        </div>

                        <div *ngIf="proximaVacuna()" class="mt-4 pt-4 border-t border-teal-200">
                            <div class="flex items-center gap-2 mb-2">
                                <svg class="w-4 h-4 text-teal-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <h5 class="text-xs font-bold text-teal-900 uppercase tracking-wide">Próxima Vacuna
                                    Recomendada</h5>
                            </div>
                            <div class="bg-white rounded-lg p-3 border border-teal-100">
                                <p class="text-sm font-bold text-slate-800">{{ proximaVacuna()?.nombre }}</p>
                                <div class="flex items-center gap-2 mt-1">
                                    <span
                                        class="inline-flex items-center px-2 py-0.5 rounded-md text-xs font-semibold bg-teal-100 text-teal-700">
                                        {{ proximaVacuna()?.dosis }}
                                    </span>
                                    <span class="text-xs text-slate-500">{{ proximaVacuna()?.edadRecomendada }}</span>
                                </div>
                                <p *ngIf="proximaVacuna()?.descripcion" class="text-xs text-slate-600 mt-2">
                                    {{ proximaVacuna()?.descripcion }}
                                </p>
                            </div>
                        </div>

                        <div *ngIf="!proximaVacuna()" class="mt-4 pt-4 border-t border-teal-200">
                            <div class="flex items-center gap-2 text-teal-700">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <p class="text-xs font-semibold">Esquema de vacunación completo para la edad actual</p>
                            </div>
                        </div>

                        <!-- Vacunas Pendientes -->
                        <div *ngIf="vacunasPendientes().length > 0" class="mt-4 pt-4 border-t border-teal-200">
                            <div class="flex items-center gap-2 mb-2">
                                <svg class="w-4 h-4 text-amber-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                                <h5 class="text-xs font-bold text-amber-900 uppercase tracking-wide">
                                    Vacunas Pendientes ({{ vacunasPendientes().length }})
                                </h5>
                            </div>
                            <div class="bg-amber-50 rounded-lg p-3 border border-amber-200 max-h-32 overflow-y-auto">
                                <ul class="space-y-1.5">
                                    <li *ngFor="let vacuna of vacunasPendientes()"
                                        class="flex items-start gap-2 text-xs">
                                        <span class="text-amber-600 mt-0.5">•</span>
                                        <div class="flex-1">
                                            <span class="font-semibold text-slate-800">{{ vacuna.nombre }}</span>
                                            <span class="text-slate-500"> - {{ vacuna.dosis }}</span>
                                            <span class="text-amber-700 block text-[10px]">{{ vacuna.edadRecomendada
                                                }}</span>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Form -->
                <div class="xl:col-span-1 flex flex-col gap-4">

                    <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <svg class="w-5 h-5 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                        </svg>
                        Administrar Vacuna
                    </h3>

                    <form [formGroup]="vacunaForm"
                        class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex flex-col gap-5 h-full relative">
                        <div class="space-y-5 flex-1">
                            <!-- Lote Search -->
                            <div class="relative">
                                <label class="block text-sm font-semibold text-slate-700 mb-1.5">Lote / Batch
                                    (Buscar)</label>
                                <input type="text" formControlName="lote" placeholder="Escriba lote para buscar..."
                                    (blur)="closeDropdown()"
                                    class="block w-full rounded-xl border-slate-200 bg-slate-50 text-slate-800 focus:border-teal-500 focus:ring-teal-500 text-sm py-2.5 px-4" />

                                <!-- Autocomplete Dropdown -->
                                <div *ngIf="showLoteDropdown() && filteredVacunas().length > 0"
                                    class="absolute z-50 w-full mt-1 bg-white border border-slate-200 rounded-xl shadow-lg max-h-60 overflow-y-auto">
                                    <div *ngFor="let v of filteredVacunas()" (mousedown)="seleccionarVacuna(v)"
                                        class="px-4 py-3 hover:bg-teal-50 cursor-pointer flex justify-between items-center border-b border-slate-50 last:border-0">
                                        <div>
                                            <div class="text-sm font-bold text-slate-800">{{v.lote}}</div>
                                            <div class="text-xs text-slate-500">{{v.vacuna}} - Vence:
                                                {{v.fechaVencimiento | date:'dd/MM/yyyy'}}</div>
                                        </div>
                                        <span class="text-xs font-bold text-teal-600 bg-teal-50 px-2 py-0.5 rounded-md">
                                            Stock: {{v.cantidadDisponible}}
                                        </span>
                                    </div>
                                </div>
                                <div *ngIf="showLoteDropdown() && loteSearchTerm() && filteredVacunas().length === 0"
                                    class="absolute z-50 w-full mt-1 bg-white border border-slate-200 rounded-xl shadow-lg p-4 text-center text-sm text-slate-500">
                                    No se encontraron vacunas con ese lote.
                                </div>
                            </div>

                            <!-- Vacuna Readonly -->
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1.5">Vacuna</label>
                                <div class="relative">
                                    <input type="text" formControlName="vacunaNombre"
                                        class="block w-full rounded-xl border-slate-200 bg-slate-100 text-slate-600 focus:border-slate-200 focus:ring-0 text-sm py-2.5 px-4 font-semibold" />
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-1.5">Fecha</label>
                                    <input type="date" formControlName="fechaAplicacion" readonly
                                        class="block w-full rounded-xl border-slate-200 bg-slate-100 text-slate-600 focus:border-slate-200 focus:ring-0 text-sm py-2.5 px-4 cursor-not-allowed" />
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-1.5">Dosis</label>
                                    <select formControlName="dosis"
                                        class="block w-full rounded-xl border-slate-200 bg-slate-50 text-slate-800 focus:border-teal-500 focus:ring-teal-500 text-sm py-2.5 px-4">
                                        <option value="1°">1°</option>
                                        <option value="2°">2°</option>
                                        <option value="3°">3°</option>
                                        <option value="Refuerzo">Refuerzo</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1.5">Administrado
                                    por</label>
                                <div
                                    class="flex items-center gap-2 px-4 py-2.5 bg-slate-100 rounded-xl border border-slate-200">
                                    <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                    </svg>
                                    <input type="text" readonly
                                        [value]="currentUser()?.nombre + ' ' + currentUser()?.apellido"
                                        class="bg-transparent border-none p-0 w-full text-sm text-slate-600 focus:ring-0 font-medium" />
                                    <svg class="w-5 h-5 text-teal-500" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1.5">Notas Clínicas</label>
                                <textarea rows="3" formControlName="observaciones"
                                    placeholder="Reacciones, observaciones..."
                                    class="block w-full rounded-xl border-slate-200 bg-slate-50 text-slate-800 focus:border-teal-500 focus:ring-teal-500 text-sm p-4 resize-none"></textarea>
                            </div>
                        </div>

                        <div class="pt-4 border-t border-slate-100 mt-2">
                            <button (click)="guardarAplicacion()" [disabled]="vacunaForm.invalid"
                                class="w-full bg-teal-600 hover:bg-teal-700 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3.5 px-4 rounded-xl shadow-md shadow-teal-600/20 transition-all flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                                </svg>
                                Confirmar y Firmar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>